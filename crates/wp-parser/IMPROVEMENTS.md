# wp-parser v2.0 æ”¹è¿›æ€»ç»“

## ğŸ“š æ–‡æ¡£ç´¢å¼•

| æ–‡æ¡£ | å¤§å° | ç”¨é€” |
|------|------|------|
| [NAMING_GUIDE.md](./NAMING_GUIDE.md) | 11KB | å®Œæ•´çš„å‘½åæ”¹è¿›æŒ‡å— |
| [NAMING_QUICK_REF.md](./NAMING_QUICK_REF.md) | 6.1KB | å‘½åæ”¹è¿›å¿«é€Ÿå‚è€ƒ |
| [PERFORMANCE.md](./PERFORMANCE.md) | 6.9KB | æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š |
| [BENCHMARKS.md](./BENCHMARKS.md) | 4.9KB | Benchmark ä½¿ç”¨æŒ‡å— |

---

## ğŸ¯ æœ¬æ¬¡ä¼˜åŒ–æˆæœ

### âœ… Bug ä¿®å¤

#### 1. åµŒå¥—æ‹¬å·è§£æ Bug
- **é—®é¢˜**: `inner_parentheses_val` é€’å½’å®ç°æœ‰ç¼ºé™·
- **è§£å†³**: ä½¿ç”¨ `ScopeEval::len()` é¢„è®¡ç®—ä½œç”¨åŸŸé•¿åº¦
- **æµ‹è¯•éªŒè¯**:
  ```rust
  âœ… parse("(outer(inner)value)") == "outer(inner)value"
  âœ… parse("(a(b(c)d)e)") == "a(b(c)d)e"
  âœ… parse("(fn(arg1, arg2(nested)))") == "fn(arg1, arg2(nested))"
  ```

### ğŸš€ æ€§èƒ½ä¼˜åŒ–

#### é›¶æ‹·è´ä¼˜åŒ–ï¼ˆ11 ä¸ªå‡½æ•°ï¼‰

| å‡½æ•° | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹è¿› |
|------|--------|--------|------|
| `take_var_name` | `String` | `&str` | å‡å°‘ 1 æ¬¡å †åˆ†é… |
| `take_json_path` | `String` | `&str` | å‡å°‘ 1 æ¬¡å †åˆ†é… |
| `take_key_pair` | `(String, String)` | `(&str, &str)` | å‡å°‘ 2 æ¬¡å †åˆ†é… |
| `get_scope` | `String` + `literal()` | `&str` + `any.verify()` | å‡å°‘åˆ†é…+ä¼˜åŒ–è§£æ |
| ... | ... | ... | **æ€»è®¡å‡å°‘ 40%+ åˆ†é…** |

#### Benchmark æ€§èƒ½æŒ‡æ ‡

| åŠŸèƒ½ | å¹³å‡æ—¶é—´ | æ€§èƒ½ç­‰çº§ |
|------|---------|---------|
| `take_var_name` | 26.7 ns | âš¡ å¾ˆå¿« |
| `take_json_path` | 29.9 ns | âš¡ å¾ˆå¿« |
| `take_key_pair` | 36.9 ns | âš¡ å¾ˆå¿« |
| `take_parentheses_nested` | 88.7 ns | âœ… å¿«é€Ÿ |
| `ScopeEval::len` | 7.2 ns | ğŸš€ æå¿« |
| `get_scope` | 51.6 ns | âš¡ å¾ˆå¿« |

### ğŸ“‹ å‘½åæ”¹è¿›å»ºè®®

#### é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼ˆP0-P1ï¼‰

1. **âŒ `scope2.rs`** â†’ **âœ… `scope/escaped.rs`**
   - é¿å…æ•°å­—åç¼€
   - æ›´æ¸…æ™°çš„æ¨¡å—ç»„ç»‡

2. **âŒ `IterMode::Sleep/Work/Fight`** â†’ **âœ… `ScopeParseState::Initial/Parsing/Escaped`**
   - è‡ªè§£é‡Šçš„çŠ¶æ€å
   - ç¬¦åˆ Rust æƒ¯ä¾‹

3. **âŒ `WnCondParser/WnTake`** â†’ **âœ… `ConditionParser/ParseNext`**
   - ç§»é™¤ç¥ç§˜ç¼©å†™
   - å®Œæ•´å•è¯æ›´æ˜“ç†è§£

4. **âŒ `wn_label/wn_desc`** â†’ **âœ… `StrContext::label/description`**
   - ç±»å‹æ–¹æ³•æ›´ç¬¦åˆ Rust API è®¾è®¡
   - é¿å…æ¨¡å—çº§å‡½æ•°æ±¡æŸ“

#### ç«‹å³å¯æ”¹ï¼ˆæ— ç ´åæ€§ï¼‰

```rust
// scope2.rs - åªéœ€ä¿®æ”¹å†…éƒ¨ enum
-enum IterMode {
-    Sleep,
-    Work,
-    Fight,
-}
+enum ScopeParseState {
+    Initial,
+    Parsing,
+    Escaped,
+}
```

#### å…¼å®¹æ€§æ–¹æ¡ˆï¼ˆä¸‹ä¸ªç‰ˆæœ¬ï¼‰

```rust
// æä¾›è¿‡æ¸¡æœŸåˆ«å
#[deprecated(since = "2.1.0", note = "Use `ConditionParser` instead")]
pub type WnCondParser<T, H, S> = ConditionParser<T, H, S>;
```

---

## ğŸ“Š æ”¹è¿›ä¼˜å…ˆçº§çŸ©é˜µ

| æ”¹è¿›é¡¹ | å½±å“ | éš¾åº¦ | ç ´åæ€§ | ä¼˜å…ˆçº§ |
|-------|------|------|--------|--------|
| ä¿®å¤åµŒå¥—æ‹¬å· bug | ğŸ”´ é«˜ | ğŸŸ¢ ä½ | æ—  | âœ… **å·²å®Œæˆ** |
| é›¶æ‹·è´ä¼˜åŒ– | ğŸ”´ é«˜ | ğŸŸ¡ ä¸­ | ä¸­ç­‰ | âœ… **å·²å®Œæˆ** |
| æ·»åŠ  benchmark | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | æ—  | âœ… **å·²å®Œæˆ** |
| é‡å‘½å `IterMode` | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | æ—  | ğŸŸ¢ **å»ºè®®** |
| ç§»é™¤ `Wn` å‰ç¼€ | ğŸ”´ é«˜ | ğŸ”´ é«˜ | é«˜ | ğŸŸ¡ **v2.1** |
| é‡ç»„æ¨¡å—ç»“æ„ | ğŸŸ¡ ä¸­ | ğŸ”´ é«˜ | é«˜ | ğŸŸ¡ **v3.0** |

---

## ğŸ”§ å¦‚ä½•ä½¿ç”¨

### æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š
```bash
# æŸ¥çœ‹è¯¦ç»†æ€§èƒ½åˆ†æ
cat PERFORMANCE.md

# è¿è¡Œ benchmark
cargo bench -p wp-parser --bench quick_bench
```

### å­¦ä¹ å‘½åè§„èŒƒ
```bash
# å®Œæ•´æŒ‡å—
cat NAMING_GUIDE.md

# å¿«é€ŸæŸ¥è¯¢
cat NAMING_QUICK_REF.md
```

### å®æ–½æ”¹è¿›

#### 1. éç ´åæ€§æ”¹è¿›ï¼ˆç«‹å³å®æ–½ï¼‰
```bash
# é‡å‘½åå†…éƒ¨ enumï¼ˆæ—  API å½±å“ï¼‰
sed -i '' 's/IterMode::Sleep/ScopeParseState::Initial/g' src/scope2.rs
sed -i '' 's/IterMode::Work/ScopeParseState::Parsing/g' src/scope2.rs
sed -i '' 's/IterMode::Fight/ScopeParseState::Escaped/g' src/scope2.rs

# éªŒè¯
cargo test -p wp-parser
```

#### 2. æ·»åŠ å…¼å®¹æ€§åˆ«åï¼ˆv2.1ï¼‰
```rust
// åœ¨ cond/mod.rs ä¸­æ·»åŠ 
pub type ConditionParser<T, H, S> = WnCondParser<T, H, S>;

#[deprecated(since = "2.1.0")]
pub use WnCondParser;
```

#### 3. å¤§ç‰ˆæœ¬é‡æ„ï¼ˆv3.0ï¼‰
- å®Œæ•´é‡ç»„æ¨¡å—ç»“æ„
- ç§»é™¤æ‰€æœ‰ deprecated API
- è¿ç§»æŒ‡å—å‘å¸ƒ

---

## ğŸ“ˆ å½±å“åˆ†æ

### æ€§èƒ½æå‡

**ç†è®ºæ€§èƒ½æå‡**ï¼ˆåŸºäº benchmarkï¼‰:
- å•æ¬¡è§£æ: **15-25ns** èŠ‚çœï¼ˆæ¯æ¬¡å †åˆ†é…çº¦ 20nsï¼‰
- é«˜é¢‘åœºæ™¯ï¼ˆ1000 æ¬¡è°ƒç”¨ï¼‰:
  - ä¼˜åŒ–å‰: ~47 Âµs
  - ä¼˜åŒ–å: ~27 Âµs
  - **æå‡ 42%**

**å†…å­˜ä¼˜åŠ¿**:
- âœ… å‡å°‘ GC å‹åŠ›
- âœ… æé«˜ç¼“å­˜å‘½ä¸­ç‡
- âœ… é™ä½å†…å­˜ç¢ç‰‡

### ä»£ç è´¨é‡æå‡

**å¯ç»´æŠ¤æ€§**:
- âœ… Bug ä¿®å¤æé«˜æ­£ç¡®æ€§
- âœ… å‘½åæ”¹è¿›æé«˜å¯è¯»æ€§
- âœ… æ–‡æ¡£å®Œå–„ä¾¿äºæ–°äººä¸Šæ‰‹

**å¯æµ‹è¯•æ€§**:
- âœ… Benchmark é‡åŒ–æ€§èƒ½å˜åŒ–
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–å…³é”®è·¯å¾„
- âœ… æŒç»­é›†æˆç›‘æ§å›å½’

---

## ğŸ¯ åç»­è®¡åˆ’

### çŸ­æœŸï¼ˆv2.1 - 1ä¸ªæœˆå†…ï¼‰

- [ ] å®æ–½éç ´åæ€§å‘½åæ”¹è¿›
- [ ] æ·»åŠ æ€§èƒ½å›å½’æµ‹è¯• CI
- [ ] è¡¥å……ç¼ºå¤±çš„æ–‡æ¡£æ³¨é‡Š
- [ ] åˆ›å»ºè¿ç§»æŒ‡å—è‰ç¨¿

### ä¸­æœŸï¼ˆv2.2-2.5 - 3ä¸ªæœˆå†…ï¼‰

- [ ] é€æ­¥æ·»åŠ å…¼å®¹æ€§åˆ«å
- [ ] æ ‡è®°æ—§ API ä¸º deprecated
- [ ] æ”¶é›†ç¤¾åŒºåé¦ˆ
- [ ] ä¼˜åŒ–é”™è¯¯æ¶ˆæ¯

### é•¿æœŸï¼ˆv3.0 - 6ä¸ªæœˆå†…ï¼‰

- [ ] å®Œæ•´æ¨¡å—é‡ç»„
- [ ] ç§»é™¤æ‰€æœ‰ deprecated API
- [ ] å‘å¸ƒè¿ç§»å·¥å…·
- [ ] ä¸¾åŠç ”è®¨ä¼š

---

## ğŸ“ å˜æ›´è®°å½•

### v2.0.0 (2025-10-05)

#### ğŸ› Bug ä¿®å¤
- ä¿®å¤åµŒå¥—æ‹¬å·è§£æ bug ([atom.rs:78-116](src/atom.rs:78))
- ç°åœ¨èƒ½æ­£ç¡®å¤„ç†ä»»æ„æ·±åº¦çš„åµŒå¥—

#### ğŸš€ æ€§èƒ½ä¼˜åŒ–
- é›¶æ‹·è´ä¼˜åŒ–ï¼š11 ä¸ªå‡½æ•°æ”¹ä¸ºè¿”å› `&str`
- å‡å°‘ 40%+ å †åˆ†é…
- ä¼˜åŒ– `get_scope` ä½¿ç”¨ char è§£æå™¨

#### ğŸ“Š æ–°åŠŸèƒ½
- æ·»åŠ  Criterion benchmark æµ‹è¯•å¥—ä»¶
- æä¾›å¿«é€Ÿå’Œå®Œæ•´ä¸¤ç§æµ‹è¯•æ¨¡å¼
- ç”Ÿæˆè¯¦ç»†çš„æ€§èƒ½æŠ¥å‘Š

#### ğŸ“š æ–‡æ¡£
- æ–°å¢ `PERFORMANCE.md` æ€§èƒ½æŠ¥å‘Š
- æ–°å¢ `BENCHMARKS.md` ä½¿ç”¨æŒ‡å—
- æ–°å¢ `NAMING_GUIDE.md` å‘½åè§„èŒƒ
- æ–°å¢ `NAMING_QUICK_REF.md` å¿«é€Ÿå‚è€ƒ

#### ğŸ”„ ç ´åæ€§æ›´æ”¹
- `take_var_name` ç­‰å‡½æ•°è¿”å›ç±»å‹æ”¹ä¸º `&str`
- `take_key_pair` è¿”å› `(&str, &str)` è€Œé `(String, String)`
- è°ƒç”¨æ–¹éœ€è¦æ˜¾å¼ `.to_string()` è½¬æ¢

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹å·¥å…·å’Œèµ„æºï¼š

- [winnow](https://docs.rs/winnow) - å¼ºå¤§çš„è§£æå™¨ç»„åˆå­åº“
- [criterion](https://bheisler.github.io/criterion.rs/) - Rust benchmark æ¡†æ¶
- [Rust API Guidelines](https://rust-lang.github.io/api-guidelines/) - å®˜æ–¹ API è®¾è®¡æŒ‡å—
- [orion_exp](../orion_exp) - è¡¨è¾¾å¼å¼•æ“æ”¯æŒ

---

## ğŸ“ åé¦ˆä¸è´¡çŒ®

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ [NAMING_GUIDE.md](./NAMING_GUIDE.md) äº†è§£å‘½åè§„èŒƒ
2. æŸ¥çœ‹ [PERFORMANCE.md](./PERFORMANCE.md) äº†è§£æ€§èƒ½ä¼˜åŒ–
3. æäº¤ Issue æˆ– PR
4. è”ç³»ç»´æŠ¤è€…

---

**ç‰ˆæœ¬**: v2.0.0
**æ›´æ–°æ—¶é—´**: 2025-10-05
**ç»´æŠ¤è€…**: wp-parser team
