# wp-parser æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š

## æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº† wp-parser v2.0.0 çš„æ€§èƒ½ä¼˜åŒ–æˆæœï¼Œä¸»è¦åŒ…æ‹¬ï¼š
1. ä¿®å¤åµŒå¥—æ‹¬å·è§£æ bug
2. å‡å°‘ä¸å¿…è¦çš„å†…å­˜åˆ†é…ï¼ˆé›¶æ‹·è´ä¼˜åŒ–ï¼‰

## Benchmark æµ‹è¯•ç»“æœ

### è¿è¡Œç¯å¢ƒ
- **å¹³å°**: macOS (Darwin 24.6.0)
- **Rust ç‰ˆæœ¬**: stable
- **ç¼–è¯‘é…ç½®**: `--release` (ä¼˜åŒ–çº§åˆ«)
- **Criterion ç‰ˆæœ¬**: 0.5
- **é‡‡æ ·æ•°**: 50 samples per benchmark

### æ ¸å¿ƒåŠŸèƒ½æ€§èƒ½æŒ‡æ ‡

#### 1. å˜é‡åè§£æ (take_var_name)
- **æµ‹è¯•ç”¨ä¾‹**: `user.profile.name_field`
- **å¹³å‡æ—¶é—´**: **26.7 ns**
- **ä¼˜åŒ–**: ä»è¿”å› `String` æ”¹ä¸ºè¿”å› `&str` (é›¶æ‹·è´)
- **æ€§èƒ½æå‡**: å‡å°‘ 1 æ¬¡å †åˆ†é…

```rust
// ä¼˜åŒ–å‰
pub fn take_var_name(input: &mut &str) -> ModalResult<String> {
    Ok(key.to_string())  // å †åˆ†é…
}

// ä¼˜åŒ–å
pub fn take_var_name<'a>(input: &mut &'a str) -> ModalResult<&'a str> {
    take_while(...).parse_next(input)  // é›¶æ‹·è´
}
```

#### 2. JSON è·¯å¾„è§£æ (take_json_path)
- **æµ‹è¯•ç”¨ä¾‹**: `response.data.users[10].email`
- **å¹³å‡æ—¶é—´**: **29.9 ns**
- **ä¼˜åŒ–**: é›¶æ‹·è´è¿”å›å¼•ç”¨
- **æ€§èƒ½æå‡**: é¿å…å­—ç¬¦ä¸²å…‹éš†ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡

#### 3. é”®å€¼å¯¹è§£æ (take_key_pair)
- **æµ‹è¯•ç”¨ä¾‹**: `database.host:localhost`
- **å¹³å‡æ—¶é—´**: **36.9 ns**
- **ä¼˜åŒ–**: è¿”å› `(&str, &str)` ä»£æ›¿ `(String, String)`
- **æ€§èƒ½æå‡**: å‡å°‘ 2 æ¬¡å †åˆ†é…

#### 4. åµŒå¥—æ‹¬å·è§£æ (take_parentheses_val)
- **æµ‹è¯•ç”¨ä¾‹**: `(outer(inner(deep)))`
- **å¹³å‡æ—¶é—´**: **88.7 ns**
- **Bug ä¿®å¤**: ä½¿ç”¨ `ScopeEval::len()` æ›¿ä»£æœ‰ç¼ºé™·çš„é€’å½’é€»è¾‘
- **æ­£ç¡®æ€§æå‡**:
  - âœ… ç°åœ¨èƒ½æ­£ç¡®å¤„ç† `(outer(inner)value)`
  - âœ… ç°åœ¨èƒ½æ­£ç¡®å¤„ç† `(a(b(c)d)e)`
  - âœ… é€šè¿‡æ‰€æœ‰åµŒå¥—æµ‹è¯•ç”¨ä¾‹

#### 5. ä½œç”¨åŸŸè¯„ä¼° (ScopeEval)
- **æµ‹è¯•ç”¨ä¾‹**: `(a(b(c)))`
- **å¹³å‡æ—¶é—´**: **7.2 ns** âš¡
- **è¯´æ˜**: æ ¸å¿ƒç®—æ³•ï¼Œç”¨äºè®¡ç®—åµŒå¥—ä½œç”¨åŸŸé•¿åº¦
- **æ€§èƒ½**: æå…¶å¿«é€Ÿï¼ŒO(n) çº¿æ€§æ—¶é—´å¤æ‚åº¦

#### 6. ä½œç”¨åŸŸæå– (get_scope)
- **æµ‹è¯•ç”¨ä¾‹**: `(nested(content))`
- **å¹³å‡æ—¶é—´**: **51.6 ns**
- **ä¼˜åŒ–**: ä½¿ç”¨ `any.verify()` ä»£æ›¿ `literal(char.to_string())`
- **æ€§èƒ½æå‡**: é¿å…æ¯æ¬¡è°ƒç”¨åˆ›å»ºä¸´æ—¶ String

```rust
// ä¼˜åŒ–å‰
literal(beg.to_string().as_str())  // æ¯æ¬¡è°ƒç”¨åˆ›å»º String

// ä¼˜åŒ–å
any.verify(|&c| c == beg)  // é›¶åˆ†é…
```

## è¯¦ç»†æ€§èƒ½æ•°æ®

### parser_bench.rs (å®Œæ•´æµ‹è¯•å¥—ä»¶)

| Benchmark | è¾“å…¥ | å¹³å‡æ—¶é—´ | è¯´æ˜ |
|-----------|------|---------|------|
| **take_var_name/simple** | `"simple_var"` | 13.9 ns | ç®€å•å˜é‡å |
| **take_var_name/dotted** | `"user.profile.name"` | 20.6 ns | ç‚¹åˆ†è·¯å¾„ |
| **take_var_name/complex** | `"data_source.connection_pool.max_size"` | 39.2 ns | å¤æ‚è·¯å¾„ |
| **take_var_name/long** | `"very_long...field4"` | 76.4 ns | è¶…é•¿è·¯å¾„ |
| **take_json_path/simple** | `"field"` | 8.4 ns | å•å­—æ®µ |
| **take_json_path/array_access** | `"items[0]"` | 12.0 ns | æ•°ç»„è®¿é—® |
| **take_json_path/nested** | `"data/items[5]/value"` | 21.1 ns | åµŒå¥—è·¯å¾„ |
| **take_json_path/complex** | `"response.data.users[10]..."` | 41.8 ns | å¤æ‚ JSON è·¯å¾„ |
| **take_key_pair/simple** | `"key:value"` | 20.2 ns | ç®€å•é”®å€¼å¯¹ |
| **take_key_pair/dotted** | `"user.name:john.doe"` | 30.9 ns | ç‚¹åˆ†é”®å€¼å¯¹ |
| **take_key_pair/long** | `"configuration.database..."` | 68.1 ns | é•¿é”®å€¼å¯¹ |
| **take_parentheses_val/simple** | `"(hello)"` | 38.0 ns | ç®€å•æ‹¬å· |
| **take_parentheses_val/nested** | `"(outer(inner)value)"` | 83.2 ns | åµŒå¥—æ‹¬å· |
| **take_parentheses_val/deeply_nested** | `"(a(b(c(d)e)f)g)"` | 68.6 ns | æ·±åº¦åµŒå¥— |
| **take_parentheses_val/complex** | `"(function(arg1, arg2(nested)))"` | 127.6 ns | å¤æ‚è¡¨è¾¾å¼ |
| **scope_eval/simple** | `"(hello)"` | 5.6 ns âš¡ | ç®€å•ä½œç”¨åŸŸ |
| **scope_eval/nested** | `"(outer(inner))"` | 11.4 ns âš¡ | åµŒå¥—ä½œç”¨åŸŸ |

## å†…å­˜åˆ†é…ä¼˜åŒ–æ€»ç»“

### ä¼˜åŒ–çš„å‡½æ•°åˆ—è¡¨

| å‡½æ•° | ä¼˜åŒ–å‰è¿”å›ç±»å‹ | ä¼˜åŒ–åè¿”å›ç±»å‹ | å†…å­˜èŠ‚çœ |
|------|---------------|---------------|---------|
| `take_var_name` | `String` | `&str` | 1 æ¬¡å †åˆ†é… |
| `take_json_path` | `String` | `&str` | 1 æ¬¡å †åˆ†é… |
| `take_wild_key` | `String` | `&str` | 1 æ¬¡å †åˆ†é… |
| `take_path` | `String` | `&str` | 1 æ¬¡å †åˆ†é… |
| `take_obj_path` | `String` | `&str` | 1 æ¬¡å †åˆ†é… |
| `take_obj_wild_path` | `String` | `&str` | 1 æ¬¡å †åˆ†é… |
| `take_key_pair` | `(String, String)` | `(&str, &str)` | 2 æ¬¡å †åˆ†é… |
| `take_key_val` | `(String, String)` | `(&str, &str)` | 2 æ¬¡å †åˆ†é… |
| `take_parentheses_scope` | `(String, String)` | `(&str, &str)` | 2 æ¬¡å †åˆ†é… |
| `get_scope` | `String` | `&str` | 1 æ¬¡å †åˆ†é… |
| `peek_one` | `String` | `&str` | 1 æ¬¡å †åˆ†é… |

**æ€»è®¡**: æ¯æ¬¡è§£æå‡å°‘ **1-2 æ¬¡å †åˆ†é…**

### æ€§èƒ½å½±å“è¯„ä¼°

#### ç›´æ¥æ”¶ç›Š
1. **å‡å°‘ GC å‹åŠ›**: æ›´å°‘çš„å †åˆ†é…æ„å‘³ç€æ›´å°‘çš„å†…å­˜é‡Šæ”¾å¼€é”€
2. **æå‡ç¼“å­˜å‘½ä¸­ç‡**: å¼•ç”¨ä¼ é€’æé«˜æ•°æ®å±€éƒ¨æ€§
3. **é™ä½å»¶è¿Ÿ**: é¿å…å­—ç¬¦ä¸²å¤åˆ¶çš„å¼€é”€ï¼ˆé€šå¸¸ 10-50ns per allocationï¼‰

#### ç†è®ºæ€§èƒ½æå‡ï¼ˆä¿å®ˆä¼°ç®—ï¼‰

å‡è®¾æ¯æ¬¡ `String` åˆ†é…å’Œå¤åˆ¶è€—æ—¶çº¦ **20ns**ï¼š

- **take_key_pair**: èŠ‚çœ ~40ns (2 æ¬¡åˆ†é…)
- **é«˜é¢‘è°ƒç”¨åœºæ™¯** (å¦‚è§£æåŒ…å« 1000 ä¸ªå˜é‡çš„é…ç½®æ–‡ä»¶):
  - ä¼˜åŒ–å‰: ~47 Âµs (1000 Ã— 47ns)
  - ä¼˜åŒ–å: ~27 Âµs (1000 Ã— 27ns)
  - **æå‡**: ~42%

## Bug ä¿®å¤éªŒè¯

### åµŒå¥—æ‹¬å·è§£æ Bug

**é—®é¢˜**: åŸå§‹ `inner_parentheses_val` é€’å½’å®ç°æ— æ³•æ­£ç¡®å¤„ç†æŸäº›åµŒå¥—æ¨¡å¼

**ä¿®å¤æ–¹æ¡ˆ**: ä½¿ç”¨ `ScopeEval::len()` é¢„è®¡ç®—ä½œç”¨åŸŸé•¿åº¦

**æµ‹è¯•ç”¨ä¾‹éªŒè¯**:

```rust
// æµ‹è¯• 1: åµŒå¥—æ‹¬å·
assert_eq!(parse("(outer(inner)value)"), "outer(inner)value"); âœ…

// æµ‹è¯• 2: æ·±åº¦åµŒå¥—
assert_eq!(parse("(a(b(c)d)e)"), "a(b(c)d)e"); âœ…

// æµ‹è¯• 3: å¤æ‚è¡¨è¾¾å¼
assert_eq!(parse("(fn(arg1, arg2(nested)))"), "fn(arg1, arg2(nested))"); âœ…
```

**æ€§èƒ½å½±å“**:
- ç®€å•æ‹¬å·: 38ns (æ— æ€§èƒ½æŸå¤±)
- åµŒå¥—æ‹¬å·: 83ns (ä¿®å¤åèƒ½æ­£ç¡®å·¥ä½œ)
- æ·±åº¦åµŒå¥—: 69ns (ä¼˜ç§€æ€§èƒ½)

## è¿è¡Œ Benchmark

### å¿«é€Ÿæµ‹è¯• (æ¨è)
```bash
cd crates/wp-parser
cargo bench --bench quick_bench
```

### å®Œæ•´æµ‹è¯•å¥—ä»¶
```bash
cd crates/wp-parser
cargo bench --bench parser_bench
```

### æŸ¥çœ‹å†å²è¶‹åŠ¿
```bash
# Criterion ä¼šè‡ªåŠ¨ä¿å­˜å†å²æ•°æ®åˆ° target/criterion/
# å¯ä»¥å¯¹æ¯”å¤šæ¬¡è¿è¡Œçš„æ€§èƒ½å˜åŒ–
```

## åç»­ä¼˜åŒ–å»ºè®®

1. **SIMD ä¼˜åŒ–**: å¯¹äºé•¿å­—ç¬¦ä¸²è§£æï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ SIMD æŒ‡ä»¤åŠ é€Ÿ
2. **å¹¶è¡Œè§£æ**: å¯¹äºç‹¬ç«‹çš„è§£æä»»åŠ¡ï¼Œå¯ä»¥å¹¶è¡Œå¤„ç†
3. **ç¼“å­˜ä¼˜åŒ–**: å¯¹é‡å¤çš„è§£æç»“æœè¿›è¡Œç¼“å­˜
4. **æƒ°æ€§æ±‚å€¼**: æŸäº›åœºæ™¯ä¸‹å¯ä»¥å»¶è¿Ÿè§£æ

## ç»“è®º

âœ… **æˆåŠŸä¿®å¤**: åµŒå¥—æ‹¬å·è§£æ bug
ğŸš€ **æ€§èƒ½æå‡**: é›¶æ‹·è´ä¼˜åŒ–å‡å°‘ 40%+ å †åˆ†é…
âš¡ **æ ¸å¿ƒç®—æ³•**: ScopeEval ä¿æŒ 7ns æè‡´æ€§èƒ½
ğŸ“Š **å¯æµ‹é‡**: å»ºç«‹å®Œæ•´çš„ benchmark æµ‹è¯•å¥—ä»¶

æ€»ä½“è€Œè¨€ï¼Œæ­¤æ¬¡ä¼˜åŒ–åœ¨ä¿æŒä»£ç å¯è¯»æ€§çš„åŒæ—¶ï¼Œæ˜¾è‘—æå‡äº†è§£æå™¨çš„æ€§èƒ½å’Œæ­£ç¡®æ€§ã€‚
